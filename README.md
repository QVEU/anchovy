# Anchovy

## Overview

Pipeline to generate consensus viral sequences within individual cells in single-cell experiments. The package was developed for use with longread data (nanopore or PacBio). Scripts were developed to run on the NIH skyline cluster, and the job shell scripts are specific to packages installed there. Much work can be done to improve its portability and reproducibility. 

## Functions

1. The script `anchovy.py` processes a mapped SAM file, usually generated by running `minimap2` against a viral reference. The script identifies the 10X barcode signature, reads and collects the cell barcodes (CBC) based on the whitelist, and collects read sequence, barcode position, from each individual mapped read into a csv, the 'anchovy csv'.
2. `UMItoFasta.py` converts reads in 'anchovy csv' to a collection of fasta files, one for each CBC.
3. These fastas are converted to a sam file, again by `minimap2`
4. `Sam2Consensus.py` is a little script used to generate the consensus per cell from the CBC-specific SAM files.
5. The fastas are combined using `cat` to yield the 'allConsensus.fasta'
6. `ConsensusTools.ipynb` computes a consensus sequence for each collection of reads in the CBC fasta file. python script processes these consensus sequences to extract reads corresponding to the region of interest, usually the viral ORF. This outputs a consensus sequence of all the cells and the `filtConsensus.csv`.
7. Accessory R script, `Consensus_Annotation_v3.R` is used to convert these consensus sequences into the cell genotypes, and generate the genotype network from the `filtConsensus.csv`

- Steps 1-5 are included in the AnchovyJob.sh scripts in this repository, and instructions below. 

## Prerequisites
To run anchovy (steps 1-5)
- Python 3.8+
- sam2consensus.py - from [https://github.com/edgardomortiz/sam2consensus](https://github.com/edgardomortiz/sam2consensus)
To run `ConsensusTools`
- ipynb
To run `Consensus_Annotation_v3.R`
- R 13.1+
- Rstudio
- ggplot2

## Installing
The scripts are all on the QVEU skyline space at `/data/lvd_qve/QVEU_code/Anchovy/`

To install locally:

1. Clone the repository:
    ```bash
    gh repo clone QVEU/anchovy
    git clone https://github.com/yourusername/your-repo-name.git
    ```
    
2. Navigate to the project directory:
    ```bash
    cd anchovy
    ```
    
## Usage

There's two ways to run this code: 

- One is to run an edited version of the `AnchovyJob.sh` file. There are two examples in the repository, one for pacbio "PB" and one for Nanopore "NP", PB is most common. This will yield the consensus 
- The other is to run each script individually, providing the input files. 

### Anchovy Job run

Interactively:
```bash

sh AnchovyJob_script.sh path/to/whitelist_file path/to/inputdirectory path/to/template.fasta path/to/inputfilename.sam
```

or on the cluster

```bash
Job Submission with Slurm:
#slurm submission: 
srun AnchovyJob_script.sh path/to/whitelist_file path/to/inputdirectory path/to/template.fasta path/to/inputfilename.sam

```
### Contributing

- Fork the repository.
- Create a new branch (git checkout -b feature-branch).
- Commit your changes (git commit -am 'Add new feature').
- Push to the branch (git push origin feature-branch).
- Open a pull request.
